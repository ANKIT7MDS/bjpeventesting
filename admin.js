// ===============================
// Admin Panel (Visitors Only)
// - Realtime list from "visitors" (UNCHANGED)
// - Filters, search, photo preview, CSV export (UNCHANGED)
// - Delete entry (UNCHANGED)
// - тЬЕ NEW: Events collection (add + set active)
// ===============================

// тЬЕ Firebase config тАФ visitors-only panel
const firebaseConfig = {
  apiKey: "AIzaSyD-xaGtrczkUCT7rwEOuRnHzVE9AohYsKU",
  authDomain: "bjplivefirebase.firebaseapp.com",
  projectId: "bjplivefirebase"
};
if (!firebase.apps?.length) firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();

document.addEventListener("DOMContentLoaded", () => {
  const tb = document.querySelector("#dataTable tbody");
  const emptyState = document.getElementById("emptyState");

  const fromDate = document.getElementById("fromDate");
  const toDate   = document.getElementById("toDate");
  const reasonSelect = document.getElementById("reasonSelect");
  const mandalSelect = document.getElementById("mandalSelect");
  const searchInput  = document.getElementById("searchInput");
  const exportBtn    = document.getElementById("exportBtn");
  const clearBtn     = document.getElementById("clearBtn");

  // тЬЕ NEW: Event management controls (рдпрджрд┐ admin.html рдореЗрдВ рдореМрдЬреВрдж рд╣реЛрдВ рддрднреА)
  const eventNameInput = document.getElementById("eventNameInput");
  const addEventBtn = document.getElementById("addEventBtn");
  const eventList = document.getElementById("eventList");
const endEventBtn = document.getElementById("endEventBtn"); //
  let allRows = [];   // visitors рдХрд╛ рдкреВрд░рд╛ рдбреЗрдЯрд╛
  let viewRows = [];  // рдлрд╝рд┐рд▓реНрдЯрд░ рдХреЗ рдмрд╛рдж

  // рд╕реНрдерд╛рдпреА рд▓рд┐рд╕реНрдЯ (рдЖрдкрдХреЗ рдлреЙрд░реНрдо рдХреА рддрд░рд╣)
  const REASONS = [
    "рдХрд╛рд░реНрдпрд╛рд▓рдп рдкрд░ рдмреИрдардХ",
    "рдЬрд┐рд▓рд╛ рдЕрдзреНрдпрдХреНрд╖ рд╕реЗ рднреЗрдВрдЯ",
    "эК╕рд╛рдВрд╕рдлрд░ / рд╢рд╛рд╕рдХреАрдп рдХрд╛рд░реНрдп / рд╢рд┐рдХрд╛рдпрдд".replace("эК╕","рдЯ"),
    "рдХрд╛рд░реНрдпрд╛рд▓рдп рдкрд░ рд╕рд╛рдорд╛рдиреНрдп рдЙрдкрд╕реНрдерд┐рддрд┐",
    "рдЕрдиреНрдп рдХреЛрдИ рдХрд╛рд░реНрдп"
  ];
  const MANDALS = [
    "рднреЗрдВрд╕реЛрджрд╛","рднрд╛рдирдкреБрд░рд╛","рдЧрд░реЛрда","рдореЗрд▓рдЦреЗрдбрд╛","рдЦреЬрд╛рд╡рджрд╛","рд╢рд╛рдордЧреЭ","рд╕реБрд╡рд╛рд╕рд░рд╛","рдмрд╕рд╛рдИ",
    "рд╕реАрддрд╛рдордК","рдХреНрдпрд╛рдордкреБрд░","рд╕реАрддрд╛рдордК рдЧреНрд░рд╛рдореАрдг","рдЧреБрд░реНрдЬрд░ рдмрд░рдбрд┐рдпрд╛","рдзреБрдВрджрдзреЬрдХрд╛","рдмреБрдврд╛",
    "ржкрд┐рдкрд▓рд┐рдпрд╛ рдордВрдбреА".replace("ржк","рдк"),"рдорд▓реНрд╣рд╛рд░рдЧреЭ","рджрд▓реЛрджрд╛","рдордЧрд░рд╛рдорд╛рддрд╛ рдЬреА","рдордВрджрд╕реМрд░ рдЧреНрд░рд╛рдореАрдг",
    "рдордВрджрд╕реМрд░ рдЙрддреНрддрд░","рдордВрджрд╕реМрд░ рджрдХреНрд╖рд┐рдг","рдЕрдиреНрдп рдЬрд┐рд▓реЗ рд╕реЗ рдЖрдпреЗ"
  ];

  // Dropdowns рднрд░реЗрдВ (once)
  REASONS.forEach(r => {
    const op = document.createElement("option");
    op.value = r; op.textContent = r;
    reasonSelect.appendChild(op);
  });
  MANDALS.forEach(m => {
    const op = document.createElement("option");
    op.value = m; op.textContent = m;
    mandalSelect.appendChild(op);
  });

  // ЁЯФБ Realtime: visitors (latest first)
  db.collection("visitors")
    .orderBy("timestamp", "desc")
    .limit(1000)
    .onSnapshot((snap) => {
      allRows = snap.docs.map(d => ({ id: d.id, ...d.data() }));
      applyFilter();
    }, (err) => {
      console.error("Firestore listeners error:", err);
      tb.innerHTML = `<tr><td colspan="9">тЭМ рдбреЗрдЯрд╛ рд▓реЛрдб рдХрд░рдиреЗ рдореЗрдВ рд╕рдорд╕реНрдпрд╛</td></tr>`;
    });

  // ЁЯФН Filter & Search
  function applyFilter() {
    const q = (searchInput.value || "").toLowerCase().trim();
    const r = reasonSelect.value || "";
    const m = mandalSelect.value || "";

    const from = fromDate.value ? new Date(fromDate.value + "T00:00:00") : null;
    const to   = toDate.value   ? new Date(toDate.value   + "T23:59:59") : null;

    viewRows = allRows.filter(row => {
      const name   = (row.name || row["рдирд╛рдо"] || "").toLowerCase();
      const mobile = (row.mobile || row["рдореЛрдмрд╛рдЗрд▓"] || "").toLowerCase();
      const mandal = (row.mandal || row["рдордВрдбрд▓"] || "");
      const reason = (row.reason || row["рдХрд╛рд░рдг"] || "");
      const addr   = (row.address || row["рдкрддрд╛"] || "").toLowerCase();

      const matchesSearch = !q || name.includes(q) || mobile.includes(q) || addr.includes(q);
      const matchesReason = !r || reason === r;
      const matchesMandal = !m || mandal === m;

      const ts = row.timestamp?.toDate?.() ? row.timestamp.toDate() : null;
      const matchesDate = (!from && !to) || (ts && (!from || ts >= from) && (!to || ts <= to));

      return matchesSearch && matchesReason && matchesMandal && matchesDate;
    });

    render(viewRows);
  }

  // UI events
  [fromDate, toDate, reasonSelect, mandalSelect].forEach(el => {
    el.addEventListener("change", applyFilter);
  });
  searchInput.addEventListener("input", applyFilter);
  clearBtn.addEventListener("click", () => {
    fromDate.value = ""; toDate.value = "";
    reasonSelect.value = ""; mandalSelect.value = "";
    searchInput.value = "";
    applyFilter();
  });
if (endEventBtn) {
  endEventBtn.addEventListener("click", async () => {
    const ok = await Swal.fire({
      title: "рдЗрд╡реЗрдВрдЯ рд╕рдорд╛рдкреНрдд рдХрд░реЗрдВ?",
      text: "Active рдЗрд╡реЗрдВрдЯ рд╣рдЯ рдЬрд╛рдПрдЧрд╛ рдФрд░ рдлреЙрд░реНрдо default рдХрд╛рд░рдг рджрд┐рдЦрд╛рдПрдЧрд╛ред",
      icon: "question",
      showCancelButton: true,
      confirmButtonText: "рд╣рд╛рдБ, рд╕рдорд╛рдкреНрдд рдХрд░реЗрдВ"
    });
    if (!ok.isConfirmed) return;

    // рд╕рднреА active рдЗрд╡реЗрдВрдЯреНрд╕ рдХреЛ inactive рдХрд░реЗрдВ
    const snap = await db.collection("events").where("active", "==", true).get();
    const batch = db.batch();
    snap.docs.forEach(doc => batch.update(doc.ref, { active: false }));
    await batch.commit();

    Swal.fire("рд╣реЛ рдЧрдпрд╛", "рдЕрдм рдХреЛрдИ рдЗрд╡реЗрдВрдЯ Active рдирд╣реАрдВ рд╣реИред рдлреЙрд░реНрдо default рд╕реВрдЪреА рджрд┐рдЦрд╛рдПрдЧрд╛ред", "success");
  });
}

  // ЁЯЦия╕П Render table
  function render(rows) {
    tb.innerHTML = "";
    if (!rows.length) {
      emptyState.style.display = "block";
      return;
    }
    emptyState.style.display = "none";

    rows.forEach(r => {
      const ts = r.timestamp?.toDate?.() ? r.timestamp.toDate() : null;
      const timeText = ts ? ts.toLocaleString() : "";

      const name = r.name || r["рдирд╛рдо"] || "";
      const mobile = r.mobile || r["рдореЛрдмрд╛рдЗрд▓"] || "";
      const desig = r.designation || r["ржкрдж"]?.replace("ржк","рдк") || r["рдкрдж"] || "";
      const mandal = r.mandal || r["рдордВрдбрд▓"] || "";
      const reason = r.reason || r["рдХрд╛рд░рдг"] || "";
      const address = r.address || r["рдкрддрд╛"] || "";
      const selfie = r.selfie || "";

      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${timeText}</td>
        <td>${escapeHtml(name)}</td>
        <td>${mobile}</td>
        <td>${escapeHtml(desig)}</td>
        <td>${escapeHtml(mandal)}</td>
        <td>${escapeHtml(reason)}</td>
        <td>${escapeHtml(address)}</td>
        <td>${selfie ? `<img src="${selfie}" class="preview" alt="selfie">` : "тАФ"}</td>
        <td><button class="btn-del" data-id="${r.id}" data-selfie="${selfie}">ЁЯЧСя╕П</button></td>
      `;
      tb.appendChild(tr);
    });

    document.querySelectorAll("img.preview").forEach(img => {
      img.addEventListener("click", () => {
        Swal.fire({ imageUrl: img.src, imageAlt: "Selfie", showConfirmButton: false, showCloseButton: true, width: 640 });
      });
    });
  }

  // ЁЯЧСя╕П Entry Delete (Visitors collection)
  tb.addEventListener("click", async (e) => {
    const btn = e.target.closest(".btn-del");
    if (!btn) return;

    const docId = btn.dataset.id;
    const selfieUrl = btn.dataset.selfie || "";
    if (!docId) return;

    const confirm = await Swal.fire({
      title: "рдХреНрдпрд╛ рдЖрдк рдЗрд╕ рдПрдВрдЯреНрд░реА рдХреЛ рд╣рдЯрд╛рдирд╛ рдЪрд╛рд╣рддреЗ рд╣реИрдВ?",
      text: "рд╣рдЯрд╛рдиреЗ рдХреЗ рдмрд╛рдж рдбреЗрдЯрд╛ рд╡рд╛рдкрд╕ рдирд╣реАрдВ рд▓рд╛рдпрд╛ рдЬрд╛ рд╕рдХрддрд╛ред",
      icon: "warning",
      showCancelButton: true,
      confirmButtonText: "рд╣рд╛рдБ, рд╣рдЯрд╛рдПрдБ",
      cancelButtonText: "рд░рджреНрдж рдХрд░реЗрдВ"
    });
    if (!confirm.isConfirmed) return;

    try {
      await db.collection("visitors").doc(docId).delete();

      // Storage deletion рдХреЛрд╢рд┐рд╢ (SDK рди рд╣реЛ рддреЛ рдЪреБрдк)
      if (selfieUrl && firebase.storage?.refFromURL) {
        try {
          const storageRef = firebase.storage().refFromURL(selfieUrl);
          await storageRef.delete();
        } catch (e) { console.warn("Storage delete warning:", e?.message || e); }
      }

      Swal.fire("рд╣рдЯрд╛ рджрд┐рдпрд╛ рдЧрдпрд╛", "рдПрдВрдЯреНрд░реА рд╕рдлрд▓рддрд╛рдкреВрд░реНрд╡рдХ рд╣рдЯрд╛рдИ рдЧрдИред", "success");
    } catch (err) {
      console.error("Delete error:", err);
      Swal.fire("рддреНрд░реБрдЯрд┐", "рдПрдВрдЯреНрд░реА рд╣рдЯрд╛рдиреЗ рдореЗрдВ рд╕рдорд╕реНрдпрд╛ рдЖрдИред", "error");
    }
  });

  // ЁЯУе CSV Export (current filtered rows)
  exportBtn.addEventListener("click", () => {
    const header = ["рд╕рдордп","рдирд╛рдо","рдореЛрдмрд╛рдЗрд▓","рдкрдж","рдордВрдбрд▓","рдЖрдиреЗ рдХрд╛ рдХрд╛рд░рдг","рдкрддрд╛","рд╕реЗрд▓реНрдлрд╝реА URL"];
    let csv = header.join(",") + "\n";

    viewRows.forEach(r => {
      const ts = r.timestamp?.toDate?.() ? r.timestamp.toDate().toLocaleString() : "";
      const row = [
        ts,
        safeCsv(r.name || r["рдирд╛рдо"] || ""),
        (r.mobile || r["рдореЛрдмрд╛рдЗрд▓"] || ""),
        safeCsv(r.designation || r["рдкрдж"] || ""),
        safeCsv(r.mandal || r["рдордВрдбрд▓"] || ""),
        safeCsv(r.reason || r["рдХрд╛рд░рдг"] || ""),
        safeCsv(r.address || r["рдкрддрд╛"] || ""),
        (r.selfie || "")
      ];
      csv += row.join(",") + "\n";
    });

    const blob = new Blob([csv], { type: "text/csv;charset=utf-8;" });
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url; a.download = "visitors.csv"; a.click();
    URL.revokeObjectURL(url);
  });

  // Helpers
  function escapeHtml(s) {
    return (s || "").toString()
      .replace(/&/g,"&amp;").replace(/</g,"&lt;")
      .replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#039;");
  }
  function safeCsv(s) {
    const v = (s || "").toString().replace(/"/g, '""');
    return `"${v}"`;
  }

  /* ============================
     тЬЕ NEW: EVENTS MANAGEMENT
     ============================*/
  if (eventNameInput && addEventBtn && eventList) {
    // Realtime list
    db.collection("events").orderBy("name").onSnapshot((snap) => {
      const events = snap.docs.map(d => ({ id: d.id, ...d.data() }));
      renderEvents(events);
    });

    addEventBtn.addEventListener("click", async () => {
      const name = (eventNameInput.value || "").trim();
      if (!name) return alert("рдЗрд╡реЗрдВрдЯ рдХрд╛ рдирд╛рдо рд▓рд┐рдЦреЗрдВ");
      await db.collection("events").add({ name, active: false });
      eventNameInput.value = "";
      Swal.fire("рдЬреЛрдбрд╝рд╛ рдЧрдпрд╛", "рдЗрд╡реЗрдВрдЯ рд╕реВрдЪреА рдореЗрдВ рдЬреЛрдбрд╝ рджрд┐рдпрд╛ рдЧрдпрд╛ рд╣реИред", "success");
    });

    async function setActive(id) {
      const all = await db.collection("events").get();
      const batch = db.batch();
      all.docs.forEach(doc => {
        batch.update(doc.ref, { active: doc.id === id });
      });
      await batch.commit();
      Swal.fire("рд╕рдлрд▓", "рдпрд╣ рдЗрд╡реЗрдВрдЯ рдЕрдм Active рд╣реИред", "success");
    }

    function renderEvents(list) {
      if (!list.length) {
        eventList.classList.add("empty");
        eventList.textContent = "рдХреЛрдИ рдЗрд╡реЗрдВрдЯ рдирд╣реАрдВред";
        return;
      }
      eventList.classList.remove("empty");
      eventList.innerHTML = "";
      list.forEach(ev => {
        const row = document.createElement("div");
        row.style.display = "flex";
        row.style.alignItems = "center";
        row.style.gap = "10px";
        const name = document.createElement("span");
        name.textContent = ev.name + (ev.active ? "  тЬЕ (Active)" : "");
        const btn = document.createElement("button");
        btn.textContent = "Set Active";
        btn.addEventListener("click", () => setActive(ev.id));
        row.appendChild(name);
        row.appendChild(btn);
        eventList.appendChild(row);
      });
    }
  }
});
