<!DOCTYPE html>
<html lang="hi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>‡§Ü‡§ó‡§Ç‡§§‡•Å‡§ï ‡§™‡§Ç‡§ú‡•Ä‡§Ø‡§®</title>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+Devanagari&display=swap" rel="stylesheet">
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body { background: linear-gradient(135deg, #ff6a00, #ffa41b); font-family: 'Noto Sans Devanagari', sans-serif; display: flex; justify-content: center; padding: 20px 0; }
    .container { background: #fff8ef; width: 100%; max-width: 600px; border-radius: 12px; padding: 30px; box-shadow: 0 8px 24px rgba(0,0,0,0.2); }
    h2 { text-align: center; color: #ff6a00; margin-bottom: 20px; }
    label { display: block; margin-top: 15px; margin-bottom: 5px; font-weight: bold; color: #555; }
    input[type="text"], input[type="tel"], select { width: 100%; padding: 10px 14px; border: 1px solid #ccc; border-radius: 6px; font-size: 16px; }
    button, input[type="button"] { width: 100%; padding: 12px; background-color: #ff6a00; color: white; font-size: 16px; font-weight: bold; border: none; border-radius: 8px; cursor: pointer; margin-top: 20px; }
    button:disabled { background-color: #cccccc; cursor: not-allowed; }
    video, canvas { width: 70%; max-width: 250px; margin: 10px auto; display: block; border-radius: 8px; }
  </style>
</head>
<body>
  <div class="container">
    <h2 id="formHeading">‡§≠‡§æ‡§ú‡§™‡§æ ‡§ï‡§æ‡§∞‡•ç‡§Ø‡§æ‡§≤‡§Ø ‡§™‡§∞ ‡§Ü‡§™‡§ï‡§æ ‡§∏‡•ç‡§µ‡§æ‡§ó‡§§ ‡§π‡•à</h2>
    <form id="visitor-form">
        <label for="mobile">‡§Æ‡•ã‡§¨‡§æ‡§á‡§≤ ‡§®‡§Ç‡§¨‡§∞:</label>
        <div style="display: flex; align-items: center; gap: 8px;">
          <input type="tel" id="mobile" name="mobile" required pattern="[0-9]{10}" placeholder="10 ‡§Ö‡§Ç‡§ï‡•ã‡§Ç ‡§ï‡§æ ‡§Æ‡•ã‡§¨‡§æ‡§á‡§≤ ‡§®‡§Ç‡§¨‡§∞" style="flex: 1;">
          <span style="cursor: pointer; font-size: 20px; margin-top: 4px;">üîç</span>
        </div>
        <label for="name">‡§®‡§æ‡§Æ:</label>
        <input type="text" id="name" name="name" required placeholder="‡§Ö‡§™‡§®‡§æ ‡§®‡§æ‡§Æ ‡§¶‡§∞‡•ç‡§ú ‡§ï‡§∞‡•á‡§Ç">
        <label for="designation">‡§™‡§¶:</label>
        <input type="text" id="designation" name="designation" required placeholder="‡§Ü‡§™‡§ï‡§æ ‡§™‡§¶ ‡§¶‡§∞‡•ç‡§ú ‡§ï‡§∞‡•á‡§Ç">
        <label for="address">‡§™‡§§‡§æ / ‡§µ‡§æ‡§∞‡•ç‡§° / ‡§¨‡•Ç‡§•:</label>
        <input type="text" id="address" name="address" required placeholder="‡§™‡•Ç‡§∞‡§æ ‡§™‡§§‡§æ ‡§≤‡§ø‡§ñ‡•á‡§Ç">
        <label for="mandal">‡§Æ‡§Ç‡§°‡§≤:</label>
        <select id="mandal" name="mandal" required>
            <option value="">‡§Æ‡§Ç‡§°‡§≤ ‡§ö‡•Å‡§®‡•á‡§Ç</option>
            <option>‡§≠‡•á‡§Ç‡§∏‡•ã‡§¶‡§æ</option><option>‡§≠‡§æ‡§®‡§™‡•Å‡§∞‡§æ</option><option>‡§ó‡§∞‡•ã‡§†</option><option>‡§Æ‡•á‡§≤‡§ñ‡•á‡§°‡§æ</option>
            <option>‡§ñ‡•ú‡§æ‡§µ‡§¶‡§æ</option><option>‡§∂‡§æ‡§Æ‡§ó‡•ù</option><option>‡§∏‡•Å‡§µ‡§æ‡§∏‡§∞‡§æ</option><option>‡§¨‡§∏‡§æ‡§à</option>
            <option>‡§∏‡•Ä‡§§‡§æ‡§Æ‡§ä</option><option>‡§ï‡•ç‡§Ø‡§æ‡§Æ‡§™‡•Å‡§∞</option><option>‡§∏‡•Ä‡§§‡§æ‡§Æ‡§ä ‡§ó‡•ç‡§∞‡§æ‡§Æ‡•Ä‡§£</option><option>‡§ó‡•Å‡§∞‡•ç‡§ú‡§∞ ‡§¨‡§∞‡§°‡§ø‡§Ø‡§æ</option>
            <option>‡§ß‡•Å‡§Ç‡§¶‡§ß‡•ú‡§ï‡§æ</option><option>‡§¨‡•Å‡§¢‡§æ</option><option>‡§™‡§ø‡§™‡§≤‡§ø‡§Ø‡§æ ‡§Æ‡§Ç‡§°‡•Ä</option><option>‡§Æ‡§≤‡•ç‡§π‡§æ‡§∞‡§ó‡•ù</option>
            <option>‡§¶‡§≤‡•ã‡§¶‡§æ</option><option>‡§Æ‡§ó‡§∞‡§æ‡§Æ‡§æ‡§§‡§æ ‡§ú‡•Ä</option><option>‡§Æ‡§Ç‡§¶‡§∏‡•å‡§∞ ‡§ó‡•ç‡§∞‡§æ‡§Æ‡•Ä‡§£</option><option>‡§Æ‡§Ç‡§¶‡§∏‡•å‡§∞ ‡§â‡§§‡•ç‡§§‡§∞</option>
            <option>‡§Æ‡§Ç‡§¶‡§∏‡•å‡§∞ ‡§¶‡§ï‡•ç‡§∑‡§ø‡§£</option><option>‡§Ö‡§®‡•ç‡§Ø ‡§ú‡§ø‡§≤‡•á ‡§∏‡•á ‡§Ü‡§Ø‡•á</option>
        </select>
        <label for="reason">‡§Ü‡§®‡•á ‡§ï‡§æ ‡§ï‡§æ‡§∞‡§£:</label>
        <select id="reason" name="reason" required></select>
        <label>‡§∏‡•á‡§≤‡•ç‡§´‡•Ä ‡§≤‡•á‡§Ç:</label>
        <video id="camera" autoplay playsinline></video>
        <canvas id="snapshot" style="display:none;"></canvas>
        <input type="hidden" id="selfieData" name="selfieData">
        <button type="button" onclick="capturePhoto()">üì∑ ‡§´‡•ã‡§ü‡•ã ‡§≤‡•á‡§Ç</button>
        <button type="submit">‡§∏‡§¨‡§Æ‡§ø‡§ü ‡§ï‡§∞‡•á‡§Ç</button>
    </form>
  </div>

  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-storage-compat.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyD-xaGtrczkUCT7rwEOuRnHzVE9AohYsKU",
      authDomain: "bjplivefirebase.firebaseapp.com",
      projectId: "bjplivefirebase",
      storageBucket: "bjplivefirebase.appspot.com",
      messagingSenderId: "236867156337",
      appId: "1:236867156337:web:1fbd6c535689a6f34d5ed0"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    const storage = firebase.storage();

    document.addEventListener("DOMContentLoaded", () => {
      const form = document.getElementById("visitor-form");
      const mobileInput = document.getElementById("mobile");
      const formHeading = document.getElementById('formHeading');
      const reasonSelect = document.getElementById('reason');
      
      const defaultHeading = "‡§≠‡§æ‡§ú‡§™‡§æ ‡§ï‡§æ‡§∞‡•ç‡§Ø‡§æ‡§≤‡§Ø ‡§™‡§∞ ‡§Ü‡§™‡§ï‡§æ ‡§∏‡•ç‡§µ‡§æ‡§ó‡§§ ‡§π‡•à";
      const defaultReasonsHTML = `<option value="">‡§ï‡§æ‡§∞‡§£ ‡§ö‡•Å‡§®‡•á‡§Ç</option><option>‡§ï‡§æ‡§∞‡•ç‡§Ø‡§æ‡§≤‡§Ø ‡§™‡§∞ ‡§¨‡•à‡§†‡§ï</option><option>‡§ú‡§ø‡§≤‡§æ ‡§Ö‡§ß‡•ç‡§Ø‡§ï‡•ç‡§∑ ‡§∏‡•á ‡§≠‡•á‡§Ç‡§ü</option><option>‡§ü‡•ç‡§∞‡§æ‡§Ç‡§∏‡§´‡§∞ / ‡§∂‡§æ‡§∏‡§ï‡•Ä‡§Ø ‡§ï‡§æ‡§∞‡•ç‡§Ø / ‡§∂‡§ø‡§ï‡§æ‡§Ø‡§§</option><option>‡§ï‡§æ‡§∞‡•ç‡§Ø‡§æ‡§≤‡§Ø ‡§™‡§∞ ‡§∏‡§æ‡§Æ‡§æ‡§®‡•ç‡§Ø ‡§â‡§™‡§∏‡•ç‡§•‡§ø‡§§‡§ø</option><option>‡§Ö‡§®‡•ç‡§Ø ‡§ï‡•ã‡§à ‡§ï‡§æ‡§∞‡•ç‡§Ø</option>`;
      function setDefaultForm() { formHeading.textContent = defaultHeading; reasonSelect.innerHTML = defaultReasonsHTML; reasonSelect.disabled = false; }
      setDefaultForm();
      db.collection("events").where("active", "==", true).limit(1).onSnapshot(snapshot => {
        if (!snapshot.empty) {
          const eventName = snapshot.docs[0].data().name;
          formHeading.textContent = eventName;
          reasonSelect.innerHTML = `<option value="${eventName}" selected>${eventName}</option>`;
          reasonSelect.disabled = true;
        } else { setDefaultForm(); }
      });

      mobileInput.addEventListener("blur", async (e) => {
        const mobile = (e.target.value || "").toString().replace(/\D/g, "").slice(-10);
        e.target.value = mobile;
        if (mobile.length !== 10) return;

        const fillForm = (data) => {
          form.name.value = data.name || data["‡§®‡§æ‡§Æ"] || "";
          form.designation.value = data.designation || data["‡§™‡§¶"] || "";
          form.address.value = data.address || data["‡§™‡§§‡§æ"] || "";
          form.mandal.value = data.mandal || data["‡§Æ‡§Ç‡§°‡§≤"] || "";
        };

        const contactSnap = await db.collection("contacts").doc(mobile).get();
        if (contactSnap.exists) {
          fillForm(contactSnap.data());
          return;
        }

        const jilaSnap = await db.collection("jila_format_2025").where("‡§Æ‡•ã‡§¨‡§æ‡§á‡§≤", "==", mobile).limit(1).get();
        if (!jilaSnap.empty) {
          fillForm(jilaSnap.docs[0].data());
          return;
        }

        const visitorSnap = await db.collection("visitors").where("mobile", "==", mobile).orderBy("timestamp", "desc").limit(1).get();
        if (!visitorSnap.empty) {
          fillForm(visitorSnap.docs[0].data());
        }
      });
      
      const video = document.getElementById("camera");
      const canvas = document.getElementById("snapshot");
      const selfieInput = document.getElementById("selfieData");
      async function startCamera() { try { const stream = await navigator.mediaDevices.getUserMedia({ video: true }); video.srcObject = stream; } catch (err) { console.warn("Camera error:", err); Swal.fire('‡§ï‡•à‡§Æ‡§∞‡§æ ‡§§‡•ç‡§∞‡•Å‡§ü‡§ø!', '‡§ï‡•à‡§Æ‡§∞‡§æ ‡§∂‡•Å‡§∞‡•Ç ‡§®‡§π‡•Ä‡§Ç ‡§π‡•ã ‡§∏‡§ï‡§æ‡•§ ‡§ï‡•É‡§™‡§Ø‡§æ ‡§Ö‡§®‡•Å‡§Æ‡§§‡§ø ‡§¶‡•á‡§Ç‡•§', 'error'); } }
      startCamera();
      
      window.capturePhoto = function () { 
          const ctx = canvas.getContext("2d"); 
          canvas.width = video.videoWidth; 
          canvas.height = video.videoHeight; 
          ctx.drawImage(video, 0, 0); 
          selfieInput.value = canvas.toDataURL("image/jpeg", 0.8);
          canvas.style.display = "block"; 
          video.style.display = "none";
      };

      // --- Helper function to highlight invalid fields ---
      function highlightInvalid(elements) {
        elements.forEach(el => {
            if (!el) return;
            el.style.transition = 'border 0.2s';
            el.style.border = '2px solid red';
            setTimeout(() => {
                if (el.tagName.toLowerCase() === 'button') {
                    el.style.border = 'none';
                } else {
                    el.style.border = '1px solid #ccc';
                }
            }, 3000);
        });
      }

      // --- IMPROVED FORM SUBMISSION LOGIC ---
      form.addEventListener("submit", async (e) => {
          e.preventDefault();
          const submitButton = form.querySelector('button[type="submit"]');
          submitButton.disabled = true;
          submitButton.textContent = '‡§∏‡§¨‡§Æ‡§ø‡§ü ‡§π‡•ã ‡§∞‡§π‡§æ ‡§π‡•à...';

          try {
              const mobile = form.mobile.value;
              const name = form.name.value;
              const selfieData = form.selfieData.value;

              // Improved Validation Feedback
              if (!mobile || !name) {
                  Swal.fire('‡§§‡•ç‡§∞‡•Å‡§ü‡§ø!', '‡§ï‡•É‡§™‡§Ø‡§æ ‡§Æ‡•ã‡§¨‡§æ‡§á‡§≤ ‡§®‡§Ç‡§¨‡§∞ ‡§î‡§∞ ‡§®‡§æ‡§Æ ‡§≠‡§∞‡•á‡§Ç‡•§', 'error');
                  const invalidElements = [];
                  if (!mobile) invalidElements.push(form.mobile);
                  if (!name) invalidElements.push(form.name);
                  highlightInvalid(invalidElements);
                  return; 
              }

              if (!selfieData) {
                  Swal.fire('‡§§‡•ç‡§∞‡•Å‡§ü‡§ø!', '‡§ï‡•É‡§™‡§Ø‡§æ ‡§∏‡§¨‡§Æ‡§ø‡§ü ‡§ï‡§∞‡§®‡•á ‡§∏‡•á ‡§™‡§π‡§≤‡•á ‡§è‡§ï ‡§´‡•ã‡§ü‡•ã ‡§≤‡•á‡§Ç‡•§', 'error');
                  highlightInvalid([form.querySelector('button[onclick="capturePhoto()"]')]);
                  return;
              }

              // 1. Upload photo to Firebase Storage
              const timestamp = new Date();
              const filePath = `visitor_selfies/${mobile}_${timestamp.getTime()}.jpg`;
              const storageRef = storage.ref(filePath);
              const uploadTask = await storageRef.putString(selfieData, 'data_url');
              const photoURL = await uploadTask.ref.getDownloadURL();

              // 2. Prepare data for Firestore
              const visitorData = {
                  mobile: mobile,
                  name: name,
                  designation: form.designation.value,
                  address: form.address.value,
                  mandal: form.mandal.value,
                  reason: reasonSelect.disabled ? reasonSelect.value : form.reason.value,
                  photoURL: photoURL,
                  timestamp: firebase.firestore.FieldValue.serverTimestamp()
              };

              // 3. Save data to Firestore
              await db.collection("visitors").add(visitorData);
              await db.collection("contacts").doc(mobile).set({
                  name: visitorData.name,
                  designation: visitorData.designation,
                  address: visitorData.address,
                  mandal: visitorData.mandal,
                  lastVisit: visitorData.timestamp
              }, { merge: true });

              Swal.fire({
                  title: '‡§∏‡§´‡§≤‡§§‡§æ‡§™‡•Ç‡§∞‡•ç‡§µ‡§ï!',
                  text: '‡§Ü‡§™‡§ï‡•Ä ‡§ú‡§æ‡§®‡§ï‡§æ‡§∞‡•Ä ‡§∏‡§´‡§≤‡§§‡§æ‡§™‡•Ç‡§∞‡•ç‡§µ‡§ï ‡§∏‡§¨‡§Æ‡§ø‡§ü ‡§π‡•ã ‡§ó‡§à ‡§π‡•à‡•§',
                  icon: 'success',
                  timer: 2000,
                  showConfirmButton: false
              });

              // 4. Reset form
              form.reset();
              canvas.style.display = 'none';
              video.style.display = 'block';
              selfieInput.value = '';
              setDefaultForm();
              startCamera();

          } catch (error) {
              console.error("Submission Error: ", error);
              // More Detailed Error Message
              Swal.fire('‡§∏‡§¨‡§Æ‡§ø‡§∂‡§® ‡§Æ‡•á‡§Ç ‡§§‡•ç‡§∞‡•Å‡§ü‡§ø!', `‡§è‡§ï ‡§∏‡§Æ‡§∏‡•ç‡§Ø‡§æ ‡§π‡•Å‡§à: ${error.code || error.message}`, 'error');
          } finally {
              submitButton.disabled = false;
              submitButton.textContent = '‡§∏‡§¨‡§Æ‡§ø‡§ü ‡§ï‡§∞‡•á‡§Ç';
          }
      });
    });
  </script>
</body>
</html>

