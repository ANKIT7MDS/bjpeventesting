<!DOCTYPE html>
<html lang="hi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>рдЖрдЧрдВрддреБрдХ рдкрдВрдЬреАрдпрди</title>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+Devanagari&display=swap" rel="stylesheet">
  <style>
    *{box-sizing:border-box;margin:0;padding:0}
    body{background:linear-gradient(135deg,#ff6a00,#ffa41b);font-family:'Noto Sans Devanagari',sans-serif;display:flex;justify-content:center;padding:20px 0}
    .container{background:#fff8ef;width:100%;max-width:600px;border-radius:12px;padding:30px;box-shadow:0 8px 24px rgba(0,0,0,.2)}
    h2{text-align:center;color:#ff6a00;margin-bottom:20px}
    label{display:block;margin-top:15px;margin-bottom:5px;font-weight:bold;color:#555}
    input[type="text"],input[type="tel"],select{width:100%;padding:10px 14px;border:1px solid #ccc;border-radius:6px;font-size:16px}
    button{width:100%;padding:12px;background:#ff6a00;color:#fff;font-size:16px;font-weight:bold;border:none;border-radius:8px;cursor:pointer;margin-top:20px}
    button:hover{background:#e65e00}
    video,canvas{width:70%;max-width:250px;margin:10px auto;display:block;border-radius:8px}
  </style>

  <!-- Firebase compat -->
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-storage-compat.js"></script>
  <!-- SweetAlert -->
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
</head>
<body>
  <div class="container">
    <h2 id="formHeading">рднрд╛рдЬрдкрд╛ рдХрд╛рд░реНрдпрд╛рд▓рдп рдкрд░ рдЖрдкрдХрд╛ рд╕реНрд╡рд╛рдЧрдд рд╣реИ</h2>

    <form id="visitor-form">
      <label for="mobile">рдореЛрдмрд╛рдЗрд▓ рдирдВрдмрд░:</label>
      <input type="tel" id="mobile" name="mobile" required pattern="[0-9]{10}" placeholder="10 рдЕрдВрдХреЛрдВ рдХрд╛ рдореЛрдмрд╛рдЗрд▓ рдирдВрдмрд░">

      <label for="name">рдирд╛рдо:</label>
      <input type="text" id="name" name="name" required placeholder="рдЕрдкрдирд╛ рдирд╛рдо рджрд░реНрдЬ рдХрд░реЗрдВ">

      <label for="designation">рдкрдж:</label>
      <input type="text" id="designation" name="designation" required placeholder="рдЖрдкрдХрд╛ рдкрдж рджрд░реНрдЬ рдХрд░реЗрдВ">

      <label for="address">рдкрддрд╛ / рд╡рд╛рд░реНрдб / рдмреВрде:</label>
      <input type="text" id="address" name="address" required placeholder="рдкреВрд░рд╛ рдкрддрд╛ рд▓рд┐рдЦреЗрдВ">

      <label for="mandal">рдордВрдбрд▓:</label>
      <select id="mandal" name="mandal" required>
        <option value="">рдордВрдбрд▓ рдЪреБрдиреЗрдВ</option>
        <option>рднреЗрдВрд╕реЛрджрд╛</option><option>рднрд╛рдирдкреБрд░рд╛</option><option>рдЧрд░реЛрда</option><option>рдореЗрд▓рдЦреЗрдбрд╛</option>
        <option>рдЦреЬрд╛рд╡рджрд╛</option><option>рд╢рд╛рдордЧреЭ</option><option>рд╕реБрд╡рд╛рд╕рд░рд╛</option><option>рдмрд╕рд╛рдИ</option>
        <option>рд╕реАрддрд╛рдордК</option><option>рдХреНрдпрд╛рдордкреБрд░</option><option>рд╕реАрддрд╛рдордК рдЧреНрд░рд╛рдореАрдг</option><option>рдЧреБрд░реНрдЬрд░ рдмрд░рдбрд┐рдпрд╛</option>
        <option>рдзреБрдВрджрдзреЬрдХрд╛</option><option>рдмреБрдврд╛</option><option>рдкрд┐рдкрд▓рд┐рдпрд╛ рдордВрдбреА</option><option>рдорд▓реНрд╣рд╛рд░рдЧреЭ</option>
        <option>рджрд▓реЛрджрд╛</option><option>рдордЧрд░рд╛рдорд╛рддрд╛ рдЬреА</option><option>рдордВрджрд╕реМрд░ рдЧреНрд░рд╛рдореАрдг</option><option>рдордВрджрд╕реМрд░ рдЙрддреНрддрд░</option>
        <option>рдордВрджрд╕реМрд░ рджрдХреНрд╖рд┐рдг</option><option>рдЕрдиреНрдп рдЬрд┐рд▓реЗ рд╕реЗ рдЖрдпреЗ</option>
      </select>

      <label for="reason">рдЖрдиреЗ рдХрд╛ рдХрд╛рд░рдг:</label>
      <select id="reason" name="reason" required>
        <!-- Active рдЗрд╡реЗрдВрдЯ рдЖрдиреЗ рдкрд░ рдпрд╣ рд╕реВрдЪреА рдКрдкрд░ рдЗрд╡реЗрдВрдЯ рдбрд╛рд▓ рджреЗрдЧреА рдФрд░ рдЙрд╕реЗ рдкреНрд░реА-рд╕реЗрд▓реЗрдХреНрдЯ рдХрд░ рджреЗрдЧреА -->
        <option value="">рдХрд╛рд░рдг рдЪреБрдиреЗрдВ</option>
        <option>рдХрд╛рд░реНрдпрд╛рд▓рдп рдкрд░ рдмреИрдардХ</option>
        <option>рдЬрд┐рд▓рд╛ рдЕрдзреНрдпрдХреНрд╖ рд╕реЗ рднреЗрдВрдЯ</option>
        <option>рдЯреНрд░рд╛рдВрд╕рдлрд░ / рд╢рд╛рд╕рдХреАрдп рдХрд╛рд░реНрдп / рд╢рд┐рдХрд╛рдпрдд</option>
        <option>рдХрд╛рд░реНрдпрд╛рд▓рдп рдкрд░ рд╕рд╛рдорд╛рдиреНрдп рдЙрдкрд╕реНрдерд┐рддрд┐</option>
        <option>рдЕрдиреНрдп рдХреЛрдИ рдХрд╛рд░реНрдп</option>
      </select>

      <label>рд╕реЗрд▓реНрдлреА рд▓реЗрдВ:</label>
      <video id="camera" autoplay playsinline></video>
      <canvas id="snapshot" style="display:none;"></canvas>
      <input type="hidden" id="selfieData" name="selfieData">
      <button type="button" id="captureBtn">ЁЯУ╖ рдлреЛрдЯреЛ рд▓реЗрдВ</button>

      <button type="submit">рд╕рдмрдорд┐рдЯ рдХрд░реЗрдВ</button>
    </form>
  </div>

  <script>
    // === Firebase ===
    const firebaseConfig = {
      apiKey: "AIzaSyD-xaGtrczkUCT7rwEOuRnHzVE9AohYsKU",
      authDomain: "bjplivefirebase.firebaseapp.com",
      projectId: "bjplivefirebase",
      storageBucket: "bjplivefirebase.appspot.com"
    };
    if (!firebase.apps?.length) firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    const storage = firebase.storage();

    // DOM
    const form = document.getElementById("visitor-form");
    const formHeading = document.getElementById("formHeading");
    const reasonSel = document.getElementById("reason");
    const video = document.getElementById("camera");
    const canvas = document.getElementById("snapshot");
    const selfieInput = document.getElementById("selfieData");
    const captureBtn = document.getElementById("captureBtn");

    // Camera
    async function startCamera(){
      try{
        const stream = await navigator.mediaDevices.getUserMedia({ video: true });
        video.srcObject = stream;
      } catch(e){ console.warn("рдХреИрдорд░рд╛ рд╢реБрд░реВ рдирд╣реАрдВ:", e?.message||e); }
    }
    startCamera();

    // Photo
    captureBtn.addEventListener("click", () => {
      const ctx = canvas.getContext("2d");
      canvas.width = video.videoWidth; canvas.height = video.videoHeight;
      ctx.drawImage(video, 0, 0);
      selfieInput.value = canvas.toDataURL("image/jpeg");
      canvas.style.display = "block";
    });

    // --- Live config & events тЖТ header + active event prefill ---
    let EVENT_NAMES = new Set();
    function addEventOptionIfMissing(name){
      if (!name) return;
      if (!Array.from(reasonSel.options).some(o => o.value === name)){
        const op = document.createElement("option");
        op.value = name; op.textContent = name;
        reasonSel.insertBefore(op, reasonSel.firstChild.nextSibling); // "рдХрд╛рд░рдг рдЪреБрдиреЗрдВ" рдХреЗ рдареАрдХ рдмрд╛рдж
      }
    }

    // config (header + activeEventName)
    db.collection("config").doc("app").onSnapshot(doc => {
      const cfg = doc.exists ? doc.data() : {};
      if (cfg.header) formHeading.textContent = cfg.header;
      if (cfg.activeEventName){
        addEventOptionIfMissing(cfg.activeEventName);
        reasonSel.value = cfg.activeEventName; // рдкреНрд░реАрдлрд┐рд▓
      }
    });

    // events list рднреА рд╕реБрди рд▓реЗрдВ рддрд╛рдХрд┐ рдкреВрд░реЗ рдЗрд╡реЗрдВрдЯ рдХрд╛рд░рдгреЛрдВ рдореЗрдВ рдЙрдкрд▓рдмреНрдз рд░рд╣реЗрдВ
    db.collection("events").orderBy("name").onSnapshot(snap => {
      EVENT_NAMES = new Set(snap.docs.map(d => d.data().name || ""));
      // рдЗрд╡реЗрдВрдЯреНрд╕ рдХреЛ рдХрд╛рд░рдг рдореЗрдВ рдКрдкрд░ рдЬреЛрдбрд╝реЗрдВ (рдбреБрдкреНрд▓реАрдХреЗрдЯ рд╕реЗ рдмрдЪреЗрдВ)
      EVENT_NAMES.forEach(n => addEventOptionIfMissing(n));
    });

    // рдореЛрдмрд╛рдЗрд▓ рдкрд░ рдкреБрд░рд╛рдиреЗ рдбреЗрдЯрд╛ рд╕реЗ рдкреНрд░реАрдлрд┐рд▓ (рд╡реИрдХрд▓реНрдкрд┐рдХ)
    function normalizeMobile(input){
      let d = (input || "").toString().replace(/\D/g,"");
      if (d.length > 10) d = d.slice(-10);
      return d;
    }
    document.getElementById("mobile").addEventListener("blur", async (e) => {
      const mob = normalizeMobile(e.target.value);
      e.target.value = mob;
      if (mob.length !== 10) return;
      const [oldSnap, newSnap] = await Promise.all([
        db.collection("jila_format_2025").where("рдореЛрдмрд╛рдЗрд▓","==",mob).limit(1).get(),
        db.collection("visitors").where("mobile","==",mob).limit(1).get()
      ]);
      const doc = newSnap.docs[0] || oldSnap.docs[0];
      if (doc){
        const d = doc.data();
        form.name.value = d["рдирд╛рдо"] || d["name"] || "";
        form.designation.value = d["рдкрдж"] || d["designation"] || "";
        form.address.value = d["рдкрддрд╛"] || d["address"] || "";
        form.mandal.value = d["рдордВрдбрд▓"] || d["mandal"] || "";
      }
    });

    // Submit
    form.addEventListener("submit", async (e) => {
      e.preventDefault();
      const btn = form.querySelector("button[type='submit']");
      btn.disabled = true;

      const name = form.name.value.trim();
      const mobile = normalizeMobile(form.mobile.value.trim());
      const designation = form.designation.value.trim();
      const address = form.address.value.trim();
      const mandal = form.mandal.value;
      const reason = form.reason.value;
      const selfieData = selfieInput.value;

      if (!name || !mobile || !designation || !address || !mandal || !reason || !selfieData) {
        alert("рд╕рднреА рдлрд╝реАрд▓реНрдб/рд╕реЗрд▓реНрдлрд╝реА рднрд░рдирд╛ рдЬрд╝рд░реВрд░реА рд╣реИред");
        btn.disabled = false; return;
      }

      try{
        const imgBlob = await (await fetch(selfieData)).blob();
        const filePath = `selfies/${Date.now()}_${mobile}.jpg`;
        const up = await storage.ref(filePath).put(imgBlob);
        const selfieURL = await up.ref.getDownloadURL();

        await db.collection("visitors").add({
          name, mobile, designation, address, mandal, reason,
          selfie: selfieURL,
          timestamp: firebase.firestore.FieldValue.serverTimestamp()
        });

        Swal.fire({ title:"тЬЕ рдзрдиреНрдпрд╡рд╛рдж!", text:"рдЖрдкрдХреА рдЬрд╛рдирдХрд╛рд░реА рд╕реЗрд╡ рд╣реЛ рдЧрдИ рд╣реИред", icon:"success", timer:1500, showConfirmButton:false });
        form.reset(); canvas.style.display="none"; selfieInput.value=""; startCamera();
      } catch(err){
        console.error("Submit error:", err);
        Swal.fire("рддреНрд░реБрдЯрд┐", "рдХреГрдкрдпрд╛ рдкреБрдирдГ рдкреНрд░рдпрд╛рд╕ рдХрд░реЗрдВред", "error");
      }
      btn.disabled = false;
    });
  </script>
</body>
</html>
