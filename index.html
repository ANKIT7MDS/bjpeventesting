<!DOCTYPE html>
<html lang="hi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>рдЖрдЧрдВрддреБрдХ рдкрдВрдЬреАрдпрди</title>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+Devanagari&display=swap" rel="stylesheet">
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body { background: linear-gradient(135deg, #ff6a00, #ffa41b); font-family: 'Noto Sans Devanagari', sans-serif; display: flex; justify-content: center; padding: 20px 0; }
    .container { background: #fff8ef; width: 100%; max-width: 600px; border-radius: 12px; padding: 30px; box-shadow: 0 8px 24px rgba(0,0,0,0.2); }
    h2 { text-align: center; color: #ff6a00; margin-bottom: 20px; }
    label { display: block; margin-top: 15px; margin-bottom: 5px; font-weight: bold; color: #555; }
    input[type="text"], input[type="tel"], select { width: 100%; padding: 10px 14px; border: 1px solid #ccc; border-radius: 6px; font-size: 16px; }
    button, input[type="button"] { width: 100%; padding: 12px; background-color: #ff6a00; color: white; font-size: 16px; font-weight: bold; border: none; border-radius: 8px; cursor: pointer; margin-top: 20px; }
    button:disabled { background-color: #cccccc; cursor: not-allowed; }
    video, canvas { width: 70%; max-width: 250px; margin: 10px auto; display: block; border-radius: 8px; }
  </style>
</head>
<body>
  <div class="container">
    <h2 id="formHeading">рднрд╛рдЬрдкрд╛ рдХрд╛рд░реНрдпрд╛рд▓рдп рдкрд░ рдЖрдкрдХрд╛ рд╕реНрд╡рд╛рдЧрдд рд╣реИ</h2>
    <form id="visitor-form">
        <label for="mobile">рдореЛрдмрд╛рдЗрд▓ рдирдВрдмрд░:</label>
        <div style="display: flex; align-items: center; gap: 8px;">
          <input type="tel" id="mobile" name="mobile" required pattern="[0-9]{10}" placeholder="10 рдЕрдВрдХреЛрдВ рдХрд╛ рдореЛрдмрд╛рдЗрд▓ рдирдВрдмрд░" style="flex: 1;">
          <span style="cursor: pointer; font-size: 20px; margin-top: 4px;">ЁЯФН</span>
        </div>
        <label for="name">рдирд╛рдо:</label>
        <input type="text" id="name" name="name" required placeholder="рдЕрдкрдирд╛ рдирд╛рдо рджрд░реНрдЬ рдХрд░реЗрдВ">
        <label for="designation">рдкрдж:</label>
        <input type="text" id="designation" name="designation" required placeholder="рдЖрдкрдХрд╛ рдкрдж рджрд░реНрдЬ рдХрд░реЗрдВ">
        <label for="address">рдкрддрд╛ / рд╡рд╛рд░реНрдб / рдмреВрде:</label>
        <input type="text" id="address" name="address" required placeholder="рдкреВрд░рд╛ рдкрддрд╛ рд▓рд┐рдЦреЗрдВ">
        <label for="mandal">рдордВрдбрд▓:</label>
        <select id="mandal" name="mandal" required>
            <option value="">рдордВрдбрд▓ рдЪреБрдиреЗрдВ</option>
            <option>рднреЗрдВрд╕реЛрджрд╛</option><option>рднрд╛рдирдкреБрд░рд╛</option><option>рдЧрд░реЛрда</option><option>рдореЗрд▓рдЦреЗрдбрд╛</option>
            <option>рдЦреЬрд╛рд╡рджрд╛</option><option>рд╢рд╛рдордЧреЭ</option><option>рд╕реБрд╡рд╛рд╕рд░рд╛</option><option>рдмрд╕рд╛рдИ</option>
            <option>рд╕реАрддрд╛рдордК</option><option>рдХреНрдпрд╛рдордкреБрд░</option><option>рд╕реАрддрд╛рдордК рдЧреНрд░рд╛рдореАрдг</option><option>рдЧреБрд░реНрдЬрд░ рдмрд░рдбрд┐рдпрд╛</option>
            <option>рдзреБрдВрджрдзреЬрдХрд╛</option><option>рдмреБрдврд╛</option><option>рдкрд┐рдкрд▓рд┐рдпрд╛ рдордВрдбреА</option><option>рдорд▓реНрд╣рд╛рд░рдЧреЭ</option>
            <option>рджрд▓реЛрджрд╛</option><option>рдордЧрд░рд╛рдорд╛рддрд╛ рдЬреА</option><option>рдордВрджрд╕реМрд░ рдЧреНрд░рд╛рдореАрдг</option><option>рдордВрджрд╕реМрд░ рдЙрддреНрддрд░</option>
            <option>рдордВрджрд╕реМрд░ рджрдХреНрд╖рд┐рдг</option><option>рдЕрдиреНрдп рдЬрд┐рд▓реЗ рд╕реЗ рдЖрдпреЗ</option>
        </select>
        <label for="reason">рдЖрдиреЗ рдХрд╛ рдХрд╛рд░рдг:</label>
        <select id="reason" name="reason" required></select>
        <label>рд╕реЗрд▓реНрдлреА рд▓реЗрдВ:</label>
        <video id="camera" autoplay playsinline></video>
        <canvas id="snapshot" style="display:none;"></canvas>
        <input type="hidden" id="selfieData" name="selfieData">
        <button type="button" onclick="capturePhoto()">ЁЯУ╖ рдлреЛрдЯреЛ рд▓реЗрдВ</button>
        <button type="submit">рд╕рдмрдорд┐рдЯ рдХрд░реЗрдВ</button>
    </form>
  </div>

  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-storage-compat.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyD-xaGtrczkUCT7rwEOuRnHzVE9AohYsKU",
      authDomain: "bjplivefirebase.firebaseapp.com",
      projectId: "bjplivefirebase",
      storageBucket: "bjplivefirebase.appspot.com", // Corrected storage bucket
      messagingSenderId: "236867156337",
      appId: "1:236867156337:web:1fbd6c535689a6f34d5ed0"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    const storage = firebase.storage();

    document.addEventListener("DOMContentLoaded", () => {
      const form = document.getElementById("visitor-form");
      const mobileInput = document.getElementById("mobile");
      const formHeading = document.getElementById('formHeading');
      const reasonSelect = document.getElementById('reason');
      
      const defaultHeading = "рднрд╛рдЬрдкрд╛ рдХрд╛рд░реНрдпрд╛рд▓рдп рдкрд░ рдЖрдкрдХрд╛ рд╕реНрд╡рд╛рдЧрдд рд╣реИ";
      const defaultReasonsHTML = `<option value="">рдХрд╛рд░рдг рдЪреБрдиреЗрдВ</option><option>рдХрд╛рд░реНрдпрд╛рд▓рдп рдкрд░ рдмреИрдардХ</option><option>рдЬрд┐рд▓рд╛ рдЕрдзреНрдпрдХреНрд╖ рд╕реЗ рднреЗрдВрдЯ</option><option>рдЯреНрд░рд╛рдВрд╕рдлрд░ / рд╢рд╛рд╕рдХреАрдп рдХрд╛рд░реНрдп / рд╢рд┐рдХрд╛рдпрдд</option><option>рдХрд╛рд░реНрдпрд╛рд▓рдп рдкрд░ рд╕рд╛рдорд╛рдиреНрдп рдЙрдкрд╕реНрдерд┐рддрд┐</option><option>рдЕрдиреНрдп рдХреЛрдИ рдХрд╛рд░реНрдп</option>`;
      function setDefaultForm() { formHeading.textContent = defaultHeading; reasonSelect.innerHTML = defaultReasonsHTML; reasonSelect.disabled = false; }
      setDefaultForm();
      db.collection("events").where("active", "==", true).limit(1).onSnapshot(snapshot => {
        if (!snapshot.empty) {
          const eventName = snapshot.docs[0].data().name;
          formHeading.textContent = eventName;
          reasonSelect.innerHTML = `<option value="${eventName}" selected>${eventName}</option>`;
          reasonSelect.disabled = true;
        } else { setDefaultForm(); }
      });

      mobileInput.addEventListener("blur", async (e) => {
        const mobile = (e.target.value || "").toString().replace(/\D/g, "").slice(-10);
        e.target.value = mobile;
        if (mobile.length !== 10) return;

        const fillForm = (data) => {
          form.name.value = data.name || data["рдирд╛рдо"] || "";
          form.designation.value = data.designation || data["рдкрдж"] || "";
          form.address.value = data.address || data["рдкрддрд╛"] || "";
          form.mandal.value = data.mandal || data["рдордВрдбрд▓"] || "";
        };

        const contactSnap = await db.collection("contacts").doc(mobile).get();
        if (contactSnap.exists) {
          fillForm(contactSnap.data());
          return;
        }

        const jilaSnap = await db.collection("jila_format_2025").where("рдореЛрдмрд╛рдЗрд▓", "==", mobile).limit(1).get();
        if (!jilaSnap.empty) {
          fillForm(jilaSnap.docs[0].data());
          return;
        }

        const visitorSnap = await db.collection("visitors").where("mobile", "==", mobile).orderBy("timestamp", "desc").limit(1).get();
        if (!visitorSnap.empty) {
          fillForm(visitorSnap.docs[0].data());
        }
      });
      
      const video = document.getElementById("camera");
      const canvas = document.getElementById("snapshot");
      const selfieInput = document.getElementById("selfieData");
      async function startCamera() { try { const stream = await navigator.mediaDevices.getUserMedia({ video: true }); video.srcObject = stream; } catch (err) { console.warn("Camera error:", err); Swal.fire('рдХреИрдорд░рд╛ рддреНрд░реБрдЯрд┐!', 'рдХреИрдорд░рд╛ рд╢реБрд░реВ рдирд╣реАрдВ рд╣реЛ рд╕рдХрд╛ред рдХреГрдкрдпрд╛ рдЕрдиреБрдорддрд┐ рджреЗрдВред', 'error'); } }
      startCamera();
      
      window.capturePhoto = function () { 
          const ctx = canvas.getContext("2d"); 
          canvas.width = video.videoWidth; 
          canvas.height = video.videoHeight; 
          ctx.drawImage(video, 0, 0); 
          selfieInput.value = canvas.toDataURL("image/jpeg", 0.8); // Compress image slightly
          canvas.style.display = "block"; 
          video.style.display = "none";
      };

      // --- ADDED FORM SUBMISSION LOGIC ---
      form.addEventListener("submit", async (e) => {
          e.preventDefault();
          const submitButton = form.querySelector('button[type="submit"]');
          submitButton.disabled = true;
          submitButton.textContent = 'рд╕рдмрдорд┐рдЯ рд╣реЛ рд░рд╣рд╛ рд╣реИ...';

          try {
              const mobile = form.mobile.value;
              const name = form.name.value;
              const selfieData = form.selfieData.value;

              if (!mobile || !name) {
                  Swal.fire('рддреНрд░реБрдЯрд┐!', 'рдХреГрдкрдпрд╛ рдореЛрдмрд╛рдЗрд▓ рдирдВрдмрд░ рдФрд░ рдирд╛рдо рднрд░реЗрдВред', 'error');
                  return;
              }

              if (!selfieData) {
                  Swal.fire('рддреНрд░реБрдЯрд┐!', 'рдХреГрдкрдпрд╛ рд╕рдмрдорд┐рдЯ рдХрд░рдиреЗ рд╕реЗ рдкрд╣рд▓реЗ рдПрдХ рдлреЛрдЯреЛ рд▓реЗрдВред', 'error');
                  return;
              }

              // 1. Upload photo to Firebase Storage
              const timestamp = new Date();
              const filePath = `visitor_selfies/${mobile}_${timestamp.getTime()}.jpg`;
              const storageRef = storage.ref(filePath);
              const uploadTask = await storageRef.putString(selfieData, 'data_url');
              const photoURL = await uploadTask.ref.getDownloadURL();

              // 2. Prepare data for Firestore
              const visitorData = {
                  mobile: mobile,
                  name: name,
                  designation: form.designation.value,
                  address: form.address.value,
                  mandal: form.mandal.value,
                  reason: reasonSelect.disabled ? reasonSelect.value : form.reason.value,
                  photoURL: photoURL,
                  timestamp: firebase.firestore.FieldValue.serverTimestamp()
              };

              // 3. Save data to Firestore
              await db.collection("visitors").add(visitorData);
              
              await db.collection("contacts").doc(mobile).set({
                  name: visitorData.name,
                  designation: visitorData.designation,
                  address: visitorData.address,
                  mandal: visitorData.mandal,
                  lastVisit: visitorData.timestamp
              }, { merge: true });

              Swal.fire({
                  title: 'рд╕рдлрд▓рддрд╛рдкреВрд░реНрд╡рдХ!',
                  text: 'рдЖрдкрдХреА рдЬрд╛рдирдХрд╛рд░реА рд╕рдлрд▓рддрд╛рдкреВрд░реНрд╡рдХ рд╕рдмрдорд┐рдЯ рд╣реЛ рдЧрдИ рд╣реИред',
                  icon: 'success',
                  timer: 2000,
                  showConfirmButton: false
              });

              // 4. Reset form
              form.reset();
              canvas.style.display = 'none';
              video.style.display = 'block';
              selfieInput.value = '';
              setDefaultForm();
              startCamera();

          } catch (error) {
              console.error("Submission Error: ", error);
              Swal.fire('рддреНрд░реБрдЯрд┐!', 'рдлреЙрд░реНрдо рд╕рдмрдорд┐рдЯ рдХрд░рдиреЗ рдореЗрдВ рдХреЛрдИ рд╕рдорд╕реНрдпрд╛ рд╣реБрдИред рдХреГрдкрдпрд╛ рдкреБрдирдГ рдкреНрд░рдпрд╛рд╕ рдХрд░реЗрдВред', 'error');
          } finally {
              submitButton.disabled = false;
              submitButton.textContent = 'рд╕рдмрдорд┐рдЯ рдХрд░реЗрдВ';
          }
      });
    });
  </script>
</body>
</html>
